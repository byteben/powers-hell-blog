<!DOCTYPE html>
<html lang="en" class="antialiased"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Control advanced power settings with PowerCfg &amp; PowerShell | Powers Hell</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Control advanced power settings with PowerCfg &amp; PowerShell" />
<meta name="author" content="Ben" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="One of the most common questions I get asked about Intune &amp; Modern Device Management is “Would it be possible to do X with Intune?” With the native support to deploy and run PowerShell scripts in either user or system contexts, this allows my answer to always be “Yes! We can do anything you want - you just need to decide on how much time you wish to invest in the solution.” Case in point - I was recently asked if it were possible to configure the power settings of a fleet of laptops to change the behaviour of the device when the lid is closed while on power." />
<meta property="og:description" content="One of the most common questions I get asked about Intune &amp; Modern Device Management is “Would it be possible to do X with Intune?” With the native support to deploy and run PowerShell scripts in either user or system contexts, this allows my answer to always be “Yes! We can do anything you want - you just need to decide on how much time you wish to invest in the solution.” Case in point - I was recently asked if it were possible to configure the power settings of a fleet of laptops to change the behaviour of the device when the lid is closed while on power." />
<meta property="og:site_name" content="Powers Hell" />
<meta property="og:image" content="/assets/images/2018/12/Capture.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-12-10T13:37:41+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="/assets/images/2018/12/Capture.png" />
<meta property="twitter:title" content="Control advanced power settings with PowerCfg &amp; PowerShell" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Ben"},"image":"/assets/images/2018/12/Capture.png","description":"One of the most common questions I get asked about Intune &amp; Modern Device Management is “Would it be possible to do X with Intune?” With the native support to deploy and run PowerShell scripts in either user or system contexts, this allows my answer to always be “Yes! We can do anything you want - you just need to decide on how much time you wish to invest in the solution.” Case in point - I was recently asked if it were possible to configure the power settings of a fleet of laptops to change the behaviour of the device when the lid is closed while on power.","headline":"Control advanced power settings with PowerCfg &amp; PowerShell","dateModified":"2018-12-10T13:37:41+00:00","datePublished":"2018-12-10T13:37:41+00:00","url":"/2018/12/10/control-advanced-power-settings-with-powercfg-powershell/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/2018/12/10/control-advanced-power-settings-with-powercfg-powershell/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/app.css">
    <link rel="stylesheet" href="/assets/css/prism-dracula.css">
</head><body>
    <div class="page-container">
      <div class="">
        <nav class="nav sticky drac-bg-blackBlack">
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 px-4 sm:px-0">
                <div class="flex items-center">
                <div class="flex-shrink-0">
                    <h2 class="drac-heading drac-heading-xl drac-text-purple-cyan"><a href="/" onmouseover="changeIn(this)" onmouseout="changeOut(this)">Powers Hell</a></h2>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                    <div class="drac-text drac-text-cyan drac-text-right drac-line-height">Great power is great fun
                    </div>
                </div>
                </div>
            </div>
            <div class="hidden sm:block">
                <div class="ml-4 items-center relative">
                <div>
                    <a href="/"
                    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan hover:drac-text-white drac-btn-sm drac-m-sm"
                    >Home</a>
                    <a href="/about"
                    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">About</a>
                    <a href="/merch"
                    class="drac-btn drac-bg-purple-transparent drac-btn-ghost drac-text-cyan drac-btn-sm drac-m-sm">Merch</a>
                </div>
                </div>
            </div>
            </div>
        </div>
        </nav>      <div class="drac-bg-blackBlack pb-6 md:pb-24 lg:pb-28 xl:pb-8">
        <header class="py-10">
          <div class="main-overlay max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            
            <h1 class="drac-heading drac-heading-2xl drac-text-center drac-text-cyan">Control advanced power settings with PowerCfg & PowerShell</h1>
            
          </div>
        </header>
      </div>
      <div>
        <svg class="wave" viewBox="0 0 1792 335" xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink">
        <path d="M 0 50 C 259 50 259 209 518 209 L 518 209 L 518 0 L 0 0 Z" stroke-width="0"></path>
        <path d="M 517 209 C 800 209 800 96 1083 96 L 1083 96 L 1083 0 L 517 0 Z" stroke-width="0"></path>
        <path d="M 1082 96 C 1437 96 1437 189 1792 189 L 1792 189 L 1792 0 L 1082 0 Z" stroke-width="0"></path>
        </svg>
      </div><main class="-mt-4 md:-mt-64 lg:-mt-72 xl:-mt-80 2xl:-mt-96">
  <div class="main-overlay max-w-5xl mx-auto pb-12 px-4 sm:px-6 lg:px-8">
    <div class=" break-normal md:break-word drac-bg-black rounded-lg shadow-2xl px-5 py-6 sm:px-6">
      <article class="markdown-body drac-text drac-line-height">

        <p class="post-date">Published: 10 Dec
        </p>
        <p>One of the most common questions I get asked about Intune &amp; Modern Device Management is “Would it be possible to do X with Intune?”</p>

<p>With the native support to deploy and run PowerShell scripts in either user or system contexts, this allows my answer to always be “Yes! We can do anything you want - you just need to decide on how much time you wish to invest in the solution.”</p>

<p>Case in point - I was recently asked if it were possible to configure the power settings of a fleet of laptops to change the behaviour of the device when the lid is closed while on power.</p>

<!--more-->

<p>“Sure thing,” I said, immediately going to the CSP policies in Intune and began to dig in looking for a native way to configure it. Unfortunately, I had no such luck.</p>

<p>While the native CSP / OMA-URI policies are growing at an exponential rate, there are still lots that can’t be done, especially with regards to power configuration of devices.</p>

<p>Right now, the native <a href="https://docs.microsoft.com/en-us/windows/client-management/mdm/policy-csp-power" rel="noopener" target="_blank">CSP policies around power configuration</a> are more focused around restricting what the end-user can configure themselves rather than what we as device admins can configure centrally.</p>

<p>Luckily, there exists (and has for quite some time) a simple way on Windows 10 devices to control all aspects of the power configuration locally - PowerCFG.</p>

<p>First Introduced in 2003, PowerCFG is a command line tool that allows us to control all configurable power system settings, including hardware-specific configurations that are not configurable through the Control Panel, on a per-user basis. (more info <a href="https://en.wikipedia.org/wiki/Powercfg" rel="noopener" target="_blank">here</a> and <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/hh875530(v=ws.10)" rel="noopener" target="_blank">here</a>)</p>

<p>Using a batch script I found over at the <a href="https://gallery.technet.microsoft.com/scriptcenter/Quickly-change-the-lid-b78eb77d#content" rel="noopener" target="_blank">TechNet Gallery</a> as a template, I quickly created a simple solution to use PowerCFG in PowerShell to achieve our end goal.</p>

<p>The key to working with most command line tools in PowerShell (especially ones where you need to work with the resultant output of the command line tool) is to store the output in a variable for later use in your script.</p>

<p>The original script had a line that attempts to capture the current power policy GUID from an output string and then trimming to store the GUID as a variable.</p>

<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="kd">Getting</span> <span class="kd">current</span> <span class="kd">scheme</span> <span class="kd">GUID</span>
<span class="k">for</span> <span class="na">/f </span><span class="s2">"tokens=* USEBACKQ"</span> <span class="vm">%%a</span> <span class="k">in</span> <span class="o">(</span><span class="sb">`powercfg /getactivescheme`</span><span class="o">)</span> <span class="k">do</span> @set <span class="kd">cfg</span><span class="o">=</span><span class="vm">%%a</span>
<span class="kd">set</span> <span class="kd">trimcfg</span><span class="o">=</span><span class="vm">%cfg</span>:<span class="o">~</span><span class="m">19</span><span class="o">,</span><span class="m">36</span><span class="err">%</span>
</code></pre></div></div>

<p>With PowerShell, we can do one better - let’s capture the GUID using a RegEx match statement!</p>

<p>First, let’s run the command and have a look at what the output actually is.</p>

<p><a href="https://i0.wp.com/i.imgur.com/Z5b1cQU.png?w=1170&#038;ssl=1" title="CMD output"><img src="https://i0.wp.com/i.imgur.com/Z5b1cQU.png?w=1170&#038;ssl=1" alt="CMD output" /></a></p>

<p>Fairly straight-forward stuff, because we know that GUIDs are always the same format, the RegEx is fairly simple to generate.</p>

<pre><code class="language-PowerShell">$activeScheme = cmd /c "powercfg /getactivescheme"
$regEx = '(\{){0,1}[0-9a-fA-F]{8}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{12}(\}){0,1}'
$asGuid = [regex]::Match($activeScheme,$regEx).Value
$asGuid
</code></pre>

<p>Now if we run the command above, we should have a usable GUID…</p>

<p><a href="https://i0.wp.com/i.imgur.com/6z917vP.png?w=1170&#038;ssl=1" title="PowerShell output"><img src="https://i0.wp.com/i.imgur.com/6z917vP.png?w=1170&#038;ssl=1" alt="PowerShell output" /></a></p>

<p>The rest of the code is fairly straightforward - find out the GUIDs that associate to the setting you want to configure (<a href="https://docs.microsoft.com/en-us/windows-hardware/customize/power-settings/configure-power-settings" rel="noopener" target="_blank">detailed documentation exists that will provide that for you</a>).</p>

<p>For this example, we just need to know the GUIDs for the “Power Button &amp; Lid Settings” &amp; the “Lid Switch Close Action”. Once we have those, we can form the correct command line argument and execute it via our script.</p>

<pre><code class="language-Powershell"># grab powercfg guids necessary for lid switch action
# https://docs.microsoft.com/en-us/windows-hardware/customize/power-settings/power-button-and-lid-settings-lid-switch-close-action

#capture the active scheme GUID
$activeScheme = cmd /c "powercfg /getactivescheme"
$regEx = '(\{){0,1}[0-9a-fA-F]{8}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{4}\-[0-9a-fA-F]{12}(\}){0,1}'
$asGuid = [regex]::Match($activeScheme,$regEx).Value

#relative GUIDs for Lid Close settings
$pwrGuid = '4f971e89-eebd-4455-a8de-9e59040e7347'
$lidClosedGuid = '5ca83367-6e45-459f-a27b-476b1d01c936'

# DC Value // On Battery // 1 = sleep
cmd /c "powercfg /setdcvalueindex $asGuid $pwrGuid $lidClosedGuid 1"
#AC Value // While plugged in // 0 = do nothing
cmd /c "powercfg /setacvalueindex $asGuid $pwrGuid $lidClosedGuid 0"

#apply settings
cmd /c "powercfg /s $asGuid"
</code></pre>

<p>This is obviously just the start of what you can do with PowerCFG, but hopefully, it shows you how you can use PowerShell &amp; Intune to answer “Yes!” to any question thrown at you.</p>

      </article>
    </div>
  </div>
<div class="main-overlay max-w-5xl mx-auto pb-12 px-4 sm:px-6 lg:px-8 drac-text-white drac-text-center">
    <div class="drac-box drac-mb-sm">
        <hr class="drac-divider drac-border-cyan" />
    </div>
    <h3 class="drac">Related Posts</h3>
    <ul class="related-footer">
        
        <li><a href="/2020/04/21/creating-endpoint-security-policies-with-powershell/">&raquo; Creating Endpoint Security Policies with PowerShell</a></li>
        
        <li><a href="/2020/03/15/synchronize-sharepoint-sites-with-intune-powershell/">&raquo; Synchronize SharePoint sites with Intune & PowerShell</a></li>
        
        <li><a href="/2019/12/13/organize-autopilot-devices-in-dynamic-aad-groups-using-grouptags-powershell/">&raquo; Organize AutoPilot devices in dynamic AAD groups using GroupTags & PowerShell</a></li>
        
        <li><a href="/2018/09/04/getting-your-aad-tenant-id-without-authentication/">&raquo; Getting your AAD Tenant Id without authentication!</a></li>
        
        <li><a href="/2020/09/20/preparing-custom-image-templates-with-azure-image-builder-powershell/">&raquo; Preparing custom image templates with Azure Image Builder & PowerShell</a></li>
        
    </ul>
</div>

</main>
</div><script src="/assets/js/app.js"></script>
<script src="/assets/js/prism.js"></script>
<script type="text/javascript" src="/assets/js/lightbox.js"></script>
<script>
    function changeIn(obj) {
    obj.className="drac-text-cyan-green"
}
function changeOut(obj) {
    obj.className="drac-text-purple-cyan"
}
</script>
<link rel="stylesheet" href="/assets/css/lightbox.css">
</div>
<div>
<svg class="wave" viewBox="0 0 1792 95.1" xmlns="http://www.w3.org/2000/svg"
xmlns:xlink="http://www.w3.org/1999/xlink">
<path d="M1792,95.1c0-27,0-54,0-80.9c-40.7-5.1-101.2-11-174.5-12.3c-185.3-3.3-260.9,26.8-411.8,42.6
c-297.5,31.2-285-56-548.1-16.1C536.2,46.6,452.1,77.6,335.5,43C294,30.7,251,10.8,179.2,3C104.9-5,42.2,4.5,0,14.1v80.9H1792z"/>
</svg>
    <footer class="main-overlay drac-bg-blackBlack flex flex-wrap items-center justify-between p-3 m-auto">
        <div class="container mx-auto flex flex-col flex-wrap items-center justify-between">
            <div class="flex mx-auto drac-text-white text-center">
                <span>
                    <p class="drac-text-purple-cyan">
                        Powers Hell © 2021
                    </p>
                </span>
            </div>
            <div class="flex mx-auto drac-text-white text-center">
                <span>
                    <p>
                        made by 
                        <a href="https://twitter.com/powers_hell" target="_blank" class="drac-text-yellow">
                            Ben
                        </a>
                        with
                        <a href="https://github.com/tabs-not-spaces/powers-hell-blog" target="_blank" class="drac-text-yellow-pink">
                            code, coffee & beer
                        </a>
                        🍻
                    </p>
                </span>
            </div>
        </div>
    </footer>
</div>
</body>

</html>